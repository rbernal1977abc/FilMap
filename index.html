<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <title>FilMap - NCR Traffic & Directions</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* BASIC STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Main container with split layout */
        .split-container {
            display: flex;
            height: 100vh;
            width: 200vw; /* 2x viewport width for split */
            transition: transform 0.3s ease;
        }
        
        .map-page, .menu-page {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Menu Page (Left) */
        .menu-page {
            background: #f8f9fa;
            overflow-y: auto;
        }
        
        .menu-page header {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 15px 20px;
            text-align: center;
            flex-shrink: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .menu-page header h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            order: 2;
        }
        
        .start-here-container {
            position: static;
            align-self: flex-start;
            margin-bottom: 10px;
            order: 1;
        }
        
        .start-here-btn {
            background: linear-gradient(to bottom, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .start-here-btn:hover {
            background: linear-gradient(to bottom, #45a049, #3d8b40);
            transform: translateY(-2px);
        }
        
        /* Map Page (Right) */
        .map-page {
            background: white;
        }
        
        .map-page header {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 15px 20px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .map-page header h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }
        
        #map {
            flex: 1;
            width: 100%;
        }
        
        /* Mobile Navigation Icons - HIDDEN */
        .mobile-nav-icons {
            display: none !important;
        }
        
        .nav-icon-btn {
            background: rgba(30, 60, 114, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .nav-icon-btn:hover {
            background: rgba(30, 60, 114, 1);
            transform: scale(1.1);
        }
        
        /* Map Controls - UPDATED */
        .map-controls { 
            position: absolute; 
            bottom: 20px; 
            right: 20px; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        
        /* Location Button */
        .location-btn {
            background: white;
            color: #1e3c72;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .location-btn:hover {
            background: #f0f0f0;
            transform: scale(1.1);
        }
        
        /* Navigation Panel - REMOVED (commented out styles kept but will not be used) */
        .navigation-panel {
            display: none !important;
        }
        
        .section-header { 
            background: linear-gradient(to right, #1e3c72, #2a5298); 
            color: white; 
            padding: 12px 15px; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            transition: all 0.3s;
        }
        .section-header:hover { background: linear-gradient(to right, #2a5298, #3a62a8); }
        .section-header h3 { margin: 0; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .toggle-icon { transition: transform 0.3s; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }
        .section-content { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            display: block;
        }
        .section-content.collapsed { display: none; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        .required::after { content: " *"; color: #f44336; }
        select, textarea, input { width: 100%; padding: 14px 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; }
        select:focus, textarea:focus, input:focus { border-color: #2a5298; outline: none; box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.2); }
        textarea { resize: vertical; min-height: 100px; }
        .button-group { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; }
        button { background: linear-gradient(to right, #1e3c72, #2a5298); color: white; border: none; padding: 16px 20px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; flex: 1; min-width: 120px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:disabled { background: #cccccc; cursor: not-allowed; opacity: 0.7; }
        button.secondary { background: linear-gradient(to right, #4CAF50, #45a049); }
        button.danger { background: linear-gradient(to right, #f44336, #d32f2f); }
        button.small { padding: 12px 15px; font-size: 0.9rem; }
        button.info { background: linear-gradient(to right, #2196F3, #1976D2); }
        button.go { background: linear-gradient(to right, #4CAF50, #45a049); }
        .location-status { padding: 12px 15px; border-radius: 10px; margin-bottom: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .location-status.success { background: #d4edda; color: #155724; border-left: 4px solid #4CAF50; }
        .location-status.error { background: #f8d7da; color: #721c24; border-left: 4px solid #f44336; }
        .location-status.loading { background: #e8f4f8; color: #0c5460; border-left: 4px solid #17a2b8; }
        .reports-list { margin-top: 20px; }
        .reports-list h3 { color: #1e3c72; margin-bottom: 15px; }
        .report-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 5px solid #4CAF50; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .report-type { background: #e8eaf6; color: #1e3c72; padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: 600; }
        .report-time { color: #666; font-size: 0.8rem; }
        .report-location { color: #333; margin: 6px 0; font-weight: 600; }
        .report-desc { color: #555; line-height: 1.5; font-size: 0.9rem; }
        .report-user { font-size: 0.8rem; color: #888; margin-top: 8px; }
        .notification { position: fixed; top: 10px; right: 10px; left: 10px; background: #4CAF50; color: white; padding: 15px; border-radius: 10px; display: none; z-index: 10000; text-align: center; }
        .notification.error { background: #f44336; }
        
        /* Directions Input Group */
        .directions-input-group { margin-bottom: 15px; }
        .directions-input { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
            align-items: center;
        }
        .directions-input .icon { 
            background: #e8eaf6; 
            border-radius: 50%; 
            width: 35px; 
            height: 35px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #1e3c72; 
            flex-shrink: 0;
        }
        .directions-input input { 
            flex: 1; 
            padding: 12px 15px; 
            border: 2px solid #e0e0e0; 
            border-radius: 10px; 
            font-size: 0.95rem;
        }
        .directions-input input:focus { 
            border-color: #2a5298; 
            outline: none;
        }
        .swap-btn { 
            background: #f0f0f0; 
            border: none; 
            border-radius: 50%; 
            width: 35px; 
            height: 35px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            margin-left: 22px;
        }
        .route-info { 
            background: #f8f9fa; 
            border-radius: 10px; 
            padding: 15px; 
            margin-top: 15px; 
            display: none;
        }
        .route-info h4 { 
            color: #1e3c72; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .route-summary { 
            display: flex; 
            justify-content: space-between; 
            background: white; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .route-summary-item { text-align: center; }
        .route-value { 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #1e3c72; 
            display: block;
        }
        .route-label { 
            font-size: 0.85rem; 
            color: #666; 
            margin-top: 5px;
        }
        .route-instructions { 
            max-height: 300px; 
            overflow-y: auto; 
            margin-top: 10px;
            padding-right: 5px;
        }
        .instruction-step { 
            padding: 12px; 
            border-left: 4px solid #2196F3; 
            margin-bottom: 10px; 
            background: white;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
        }
        .instruction-step:hover { 
            transform: translateX(5px);
            background: #f0f9ff;
        }
        .instruction-step.active { 
            border-left-color: #4CAF50;
            background: #f0f9ff;
        }
        .instruction-text { 
            color: #333; 
            font-weight: 500;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .instruction-distance { 
            color: #666; 
            font-size: 0.85rem; 
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 26px;
        }
        .instruction-icon {
            color: #2196F3;
            font-size: 0.9rem;
            min-width: 20px;
        }
        
        /* Suggestions */
        #suggestions { 
            margin-top: 10px; 
            display: none;
            position: relative;
            z-index: 1000;
        }
        .suggestion-item { 
            padding: 12px 15px; 
            border-bottom: 1px solid #eee; 
            cursor: pointer; 
            background: white;
            transition: all 0.2s;
        }
        .suggestion-item:hover { 
            background: #f5f5f5;
            transform: translateX(5px);
        }
        .suggestion-main { 
            font-weight: 600; 
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .suggestion-sub { 
            font-size: 0.85rem; 
            color: #666;
            margin-top: 4px;
            margin-left: 26px;
        }
        .suggestion-icon {
            color: #1e3c72;
            font-size: 0.9rem;
        }
        
        /* Active Route Highlight */
        .active-route { 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .split-container {
                width: 100vw;
                transform: translateX(0) !important;
            }
            
            .map-page, .menu-page {
                width: 50vw;
            }
            
            .mobile-nav-icons {
                display: none;
            }
            
            .menu-page header {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .menu-page header h1 {
                order: 1;
                margin-bottom: 0;
            }
            
            .start-here-container {
                position: static;
                order: 2;
                margin-bottom: 0;
            }
        }
        
        @media (max-width: 767px) {
            .split-container {
                width: 200vw;
            }
            
            .map-page, .menu-page {
                width: 100vw;
            }
            
            .menu-page header {
                padding: 12px 15px;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .menu-page header h1 {
                order: 2;
                align-self: center;
                width: 100%;
                text-align: center;
                margin-top: 10px;
            }
            
            .start-here-container {
                order: 1;
                align-self: flex-start;
                margin-bottom: 10px;
            }
            
            .start-here-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
            
            .route-summary { 
                flex-direction: column; 
                gap: 10px; 
            }
            .route-summary-item { flex: 1; }
            
            .navigation-panel {
                display: none;
            }
            
            /* Ensure content fits in mobile viewport */
            .menu-content {
                padding: 0 15px;
                overflow-y: auto;
                height: calc(100vh - 140px);
            }
            
            .section-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Loading FilMap...</p>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Mobile Navigation Icons - HIDDEN -->
    <div class="mobile-nav-icons" id="mobileNavIcons" style="display: none;">
        <button class="nav-icon-btn" id="menuIconBtn" title="Open Menu">
            <i class="fas fa-bars"></i>
        </button>
        <button class="nav-icon-btn" id="mapIconBtn" title="Open Map" style="display: none;">
            <i class="fas fa-map"></i>
        </button>
    </div>
    
    <!-- Location Button on Map -->
    <div class="map-controls" id="mapControls">
        <button class="location-btn" id="goToLocationBtn" title="Go to my location">
            <i class="fas fa-location-arrow"></i>
        </button>
    </div>
    
    <!-- Main split container -->
    <div class="split-container" id="splitContainer">
        <!-- Menu Page (Left) -->
        <div class="menu-page">
            <header>
                <h1>üó∫Ô∏è FilMap</h1>
                <div class="start-here-container">
                    <button class="start-here-btn" id="startHereBtn">
                        <i class="fas fa-play-circle"></i> Start Here
                    </button>
                </div>
            </header>
            
            <div class="menu-content">
                <!-- GET DIRECTIONS SECTION -->
                <div class="section-header" id="directionsHeader">
                    <h3><i class="fas fa-route"></i> Get Directions</h3>
                    <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
                </div>
                
                <div class="section-content" id="directionsContent">
                    <div class="location-status" id="locationStatus" style="display: none;">
                        <span id="locationIcon"><i class="fas fa-map-marker-alt"></i></span>
                        <span id="locationText">Detecting your location...</span>
                    </div>
                    
                    <div class="directions-input-group">
                        <div class="directions-input">
                            <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
                            <input type="text" id="fromInput" placeholder="From (My Destination)" readonly>
                        </div>
                        <div class="swap-btn" id="swapBtn">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="directions-input">
                            <div class="icon"><i class="fas fa-flag-checkered"></i></div>
                            <input type="text" id="toInput" placeholder="To (Destination in NCR)" autocomplete="off">
                        </div>
                    </div>
                    
                    <div id="suggestions">
                        <div id="suggestionsList"></div>
                    </div>
                    
                    <div class="button-group" id="directionButtons">
                        <button id="searchRouteBtn" class="info">
                            <i class="fas fa-search"></i> Search Route
                        </button>
                        <button id="clearRouteBtn" class="danger small">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                    
                    <div class="route-info" id="routeInfo">
                        <h4><i class="fas fa-info-circle"></i> Route to Destination</h4>
                        
                        <div class="route-summary">
                            <div class="route-summary-item">
                                <span class="route-value" id="routeDistance">--</span>
                                <span class="route-label">Distance</span>
                            </div>
                            <div class="route-summary-item">
                                <span class="route-value" id="routeTime">--</span>
                                <span class="route-label">Time</span>
                            </div>
                            <div class="route-summary-item">
                                <span class="route-value" id="routeTurns">--</span>
                                <span class="route-label">Turns</span>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px;"><i class="fas fa-directions"></i> Turn-by-Turn Directions</h4>
                        <div class="route-instructions" id="routeInstructions">
                            <!-- Instructions will be added here -->
                        </div>
                    </div>
                </div>
                
                <!-- REPORT TRAFFIC SECTION (Collapsible - Default Hidden) -->
                <div class="section-header" id="reportHeader">
                    <h3><i class="fas fa-edit"></i> Report Traffic</h3>
                    <span class="toggle-icon collapsed"><i class="fas fa-chevron-down"></i></span>
                </div>
                
                <div class="section-content collapsed" id="reportContent">
                    <form id="reportForm">
                        <div class="form-group">
                            <label for="trafficType" class="required"><i class="fas fa-traffic-light"></i> Traffic Condition</label>
                            <select id="trafficType" required>
                                <option value="">-- Select Type --</option>
                                <option value="light">‚úÖ Light Traffic</option>
                                <option value="moderate">‚ö†Ô∏è Moderate Traffic</option>
                                <option value="heavy">üöó Heavy Traffic</option>
                                <option value="accident">üö® Accident / Crash</option>
                                <option value="roadwork">üõ†Ô∏è Road Construction</option>
                                <option value="flood">üåä Flooding / Hazard</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="locationInput" class="required"><i class="fas fa-map-pin"></i> Location Description</label>
                            <input type="text" id="locationInput" placeholder="e.g., 'EDSA Northbound near Guadalupe'" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="description"><i class="fas fa-info-circle"></i> Additional Details (Optional)</label>
                            <textarea id="description" placeholder="Any extra information about the traffic situation..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="username" class="required"><i class="fas fa-user"></i> Your Name</label>
                            <input type="text" id="username" placeholder="Enter your name" required minlength="2">
                        </div>
                        
                        <div class="button-group">
                            <button type="button" id="useLocationBtn" class="secondary small">
                                <i class="fas fa-location-arrow"></i> My Location
                            </button>
                            <button type="button" id="clearLocationBtn" class="danger small">
                                <i class="fas fa-times"></i> Clear
                            </button>
                            <button type="submit" id="submitBtn">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- LIVE REPORTS SECTION -->
                <div class="reports-list">
                    <h3><i class="fas fa-sync-alt"></i> Live Community Reports</h3>
                    <div id="reportsContainer">
                        <p style="text-align: center; color: #777; padding: 20px;" id="noReports">
                            No reports yet. Be the first to report!
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Page (Right) -->
        <div class="map-page">
            <header>
                <h1>üó∫Ô∏è FilMap</h1>
            </header>
            
            <div id="map"></div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ============================================
        // WORKING FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDxlD4Hz5CFx88BdX53Os2PCBzroyBfusE",
            authDomain: "filmap-ncr.firebaseapp.com",
            databaseURL: "https://filmap-ncr-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "filmap-ncr",
            storageBucket: "filmap-ncr.appspot.com",
            messagingSenderId: "493798255142",
            appId: "1:493798255142:web:5b99520b9923fa051e54e7"
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        console.log("üöÄ Starting FilMap with Directions...");
        document.getElementById('loadingOverlay').style.display = 'flex';

        // Initialize Firebase
        let database, reportsRef;
        try {
            const app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            reportsRef = database.ref('trafficReports');
            console.log("‚úÖ Firebase initialized successfully");
        } catch (error) {
            console.error("‚ùå Firebase init error:", error);
            showNotification("Firebase error: " + error.message, "error");
        }

        // Initialize Map
        const map = L.map('map').setView([14.5995, 120.9842], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let selectedLocation = null;
        let userLocation = null;
        let userMarker = null;
        let watchId = null;
        let isTracking = false;
        const markers = {};
        let routingControl = null;
        let debounceTimer;
        let isReportCollapsed = true;
        let activeRoute = null;
        let routeFound = false;
        let voiceEnabled = false;
        let speechSynthesis = window.speechSynthesis;
        let currentInstructionIndex = 0;
        let isNavigationMode = false;
        let navigationSteps = [];
        
        const typeConfig = {
            light: { color: '#4CAF50', label: 'Light Traffic', emoji: '‚úÖ' },
            moderate: { color: '#FF9800', label: 'Moderate Traffic', emoji: '‚ö†Ô∏è' },
            heavy: { color: '#f44336', label: 'Heavy Traffic', emoji: 'üöó' },
            accident: { color: '#9C27B0', label: 'Accident/Crash', emoji: 'üö®' },
            roadwork: { color: '#2196F3', label: 'Road Construction', emoji: 'üõ†Ô∏è' },
            flood: { color: '#795548', label: 'Flooding/Hazard', emoji: 'üåä' }
        };

        // NCR Cities and Municipalities
        const ncrCities = [
            "Manila", "Quezon City", "Caloocan", "Las Pi√±as", "Makati", "Malabon", 
            "Mandaluyong", "Marikina", "Muntinlupa", "Navotas", "Para√±aque", 
            "Pasay", "Pasig", "Pateros", "San Juan", "Taguig", "Valenzuela"
        ];

        // NCR Major Streets and Landmarks
        const ncrLocations = [
            // Major Highways and Roads
            "EDSA", "C5 Road", "Commonwealth Avenue", "Quezon Avenue", "Roxas Boulevard",
            "Taft Avenue", "Ortigas Avenue", "Shaw Boulevard", "Kalayaan Avenue",
            "Buendia Avenue", "Gil Puyat Avenue", "Ayala Avenue", "Bonifacio Global City",
            "Makati Central Business District", "Ortigas Center", "SM Mall of Asia",
            "Robinsons Place Manila", "Greenbelt", "Glorietta", "Market! Market!",
            "Trinoma", "SM North EDSA", "Megamall", "Robinsons Galleria",
            "Ninoy Aquino International Airport", "Manila Domestic Airport",
            "Cultural Center of the Philippines", "Rizal Park", "Luneta Park",
            "Intramuros", "Binondo", "Quiapo Church", "University of the Philippines",
            "Ateneo de Manila University", "De La Salle University", "UST",
            "Manila City Hall", "Quezon City Hall", "Makati City Hall",
            // Bridges
            "Nagtahan Bridge", "Lambingan Bridge", "Makati-Mandaluyong Bridge",
            "Guadalupe Bridge", "Estrella-Pantaleon Bridge",
            // Shopping Centers
            "SM Megamall", "SM City North EDSA", "Robinsons Place Manila",
            "Glorietta", "Greenbelt", "Power Plant Mall", "Market! Market!",
            "Festival Mall", "Starmall", "SM City Fairview",
            // Hospitals
            "St. Luke's Medical Center", "Makati Medical Center", "Philippine General Hospital",
            "Medical City", "UST Hospital", "Asian Hospital",
            // Universities
            "University of the Philippines Diliman", "Ateneo de Manila University",
            "De La Salle University", "University of Santo Tomas", "FEU", "UE",
            "Polytechnic University of the Philippines", "Mapua University",
            // Government Offices
            "Senate of the Philippines", "House of Representatives", "Supreme Court",
            "Bangko Sentral ng Pilipinas", "Department of Foreign Affairs",
            // Parks and Recreation
            "Rizal Park", "Quezon Memorial Circle", "Ninoy Aquino Parks and Wildlife",
            "Manila Ocean Park", "Star City", "Enchanted Kingdom",
            // Transport Hubs
            "LRT Line 1", "LRT Line 2", "MRT Line 3", "PITX", "Cubao Bus Terminal",
            "Buendia Bus Terminal", "Pasay Rotunda"
        ];

        // ============================================
        // GO TO LOCATION BUTTON FUNCTIONALITY
        // ============================================
        document.getElementById('goToLocationBtn').addEventListener('click', function() {
            if (userLocation) {
                map.setView([userLocation.lat, userLocation.lng], 15);
                showNotification('Centered on your location');
            } else {
                getUserLocation().then(() => {
                    map.setView([userLocation.lat, userLocation.lng], 15);
                }).catch(error => {
                    showNotification('Unable to get your location', 'error');
                });
            }
        });

        // ============================================
        // PAGE NAVIGATION FUNCTIONS
        // ============================================
        let touchStartX = 0;
        let touchEndX = 0;
        let currentPage = 'map'; // 'menu' or 'map'
        
        function showMapPage() {
            const container = document.getElementById('splitContainer');
            container.style.transform = 'translateX(-100vw)';
            currentPage = 'map';
        }
        
        function showMenuPage() {
            const container = document.getElementById('splitContainer');
            container.style.transform = 'translateX(0)';
            currentPage = 'menu';
        }
        
        // Add touch events for mobile swipe
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, false);
        
        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);
        
        function handleSwipe() {
            const swipeThreshold = 50;
            const swipeDistance = touchEndX - touchStartX;
            
            if (Math.abs(swipeDistance) > swipeThreshold) {
                if (swipeDistance > 0 && currentPage === 'map') {
                    // Swipe right on map page -> show menu
                    showMenuPage();
                } else if (swipeDistance < 0 && currentPage === 'menu') {
                    // Swipe left on menu page -> show map
                    showMapPage();
                }
            }
        }
        
        // On desktop, show both pages side by side
        function checkScreenSize() {
            if (window.innerWidth >= 768) {
                const container = document.getElementById('splitContainer');
                container.style.transform = 'translateX(0)';
            } else {
                // On mobile, start on map page
                showMapPage();
            }
        }

        // ============================================
        // VOICE FUNCTIONS
        // ============================================
        function speak(text) {
            if (!voiceEnabled || !speechSynthesis) return;
            
            // Cancel any ongoing speech
            speechSynthesis.cancel();
            
            // Create utterance
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Configure for female voice
            utterance.rate = 1.0;
            utterance.pitch = 1.2;
            utterance.volume = 1;
            
            // Try to get a female voice
            const voices = speechSynthesis.getVoices();
            const femaleVoice = voices.find(voice => 
                voice.lang.includes('en') && 
                (voice.name.includes('Female') || 
                 voice.name.includes('female') ||
                 voice.name.includes('Samantha') ||
                 voice.name.includes('Karen') ||
                 voice.name.includes('Google UK English Female') ||
                 voice.name.includes('Microsoft Zira'))
            );
            
            if (femaleVoice) {
                utterance.voice = femaleVoice;
            } else {
                // Fallback to first English voice
                const englishVoice = voices.find(voice => voice.lang.includes('en'));
                if (englishVoice) utterance.voice = englishVoice;
            }
            
            // Speak the text
            speechSynthesis.speak(utterance);
        }

        function enableVoiceNavigation() {
            if (!speechSynthesis) {
                showNotification('Voice navigation not supported in your browser', 'error');
                return false;
            }
            
            voiceEnabled = true;
            showNotification('Voice navigation enabled automatically');
            
            // Speak welcome message
            if (speechSynthesis) {
                speak("Voice navigation enabled. Ready to guide you.");
            }
            
            return true;
        }

        function speakNavigationInstruction(instruction, distance) {
            if (!voiceEnabled) return;
            
            // Clean up the instruction text for speech
            let cleanText = instruction.text
                .replace(/<\/?[^>]+(>|$)/g, "") // Remove HTML tags
                .replace(/&nbsp;/g, " ") // Replace &nbsp;
                .replace(/&amp;/g, "and") // Replace &amp;
                .trim();
            
            // Add distance information
            const distanceKm = (distance / 1000).toFixed(2);
            let speechText = cleanText;
            
            if (distanceKm > 0.1) {
                speechText += ` in ${distanceKm} kilometers`;
            }
            
            speak(speechText);
        }

        // ============================================
        // TOGGLE SECTIONS
        // ============================================
        function toggleSection(sectionId) {
            const header = document.getElementById(sectionId + 'Header');
            const content = document.getElementById(sectionId + 'Content');
            const icon = header.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                // Expand
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                if (sectionId === 'report') {
                    isReportCollapsed = false;
                }
            } else {
                // Collapse
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
                if (sectionId === 'report') {
                    isReportCollapsed = true;
                }
            }
        }

        // Initialize sections
        document.getElementById('directionsHeader').addEventListener('click', () => toggleSection('directions'));
        document.getElementById('reportHeader').addEventListener('click', () => toggleSection('report'));

        // ============================================
        // DIRECTION FUNCTIONS
        // ============================================
        function showGoButton() {
            const directionButtons = document.getElementById('directionButtons');
            directionButtons.innerHTML = `
                <button id="goRouteBtn" class="go">
                    <i class="fas fa-play-circle"></i> Go
                </button>
                <button id="clearRouteBtn" class="danger small">
                    <i class="fas fa-times"></i> Clear
                </button>
            `;
            
            document.getElementById('goRouteBtn').addEventListener('click', startNavigation);
            document.getElementById('clearRouteBtn').addEventListener('click', clearRoute);
        }

        function showSearchButton() {
            const directionButtons = document.getElementById('directionButtons');
            directionButtons.innerHTML = `
                <button id="searchRouteBtn" class="info">
                    <i class="fas fa-search"></i> Search Route
                </button>
                <button id="clearRouteBtn" class="danger small">
                    <i class="fas fa-times"></i> Clear
                </button>
            `;
            
            document.getElementById('searchRouteBtn').addEventListener('click', searchRoute);
            document.getElementById('clearRouteBtn').addEventListener('click', clearRoute);
        }

        function clearRoute() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            
            // Remove route highlight
            if (activeRoute) {
                map.removeLayer(activeRoute);
                activeRoute = null;
            }
            
            document.getElementById('routeInfo').style.display = 'none';
            document.getElementById('toInput').value = '';
            document.getElementById('routeInstructions').innerHTML = '';
            document.getElementById('suggestions').style.display = 'none';
            routeFound = false;
            isNavigationMode = false;
            voiceEnabled = false;
            
            // Switch back to search button
            showSearchButton();
            
            // Stop voice
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
            
            // Switch to map page
            showMapPage();
        }

        function swapLocations() {
            const fromValue = document.getElementById('fromInput').value;
            const toValue = document.getElementById('toInput').value;
            
            if (fromValue === "My Current Location") {
                showNotification("Cannot swap with current location", "error");
                return;
            }
            
            document.getElementById('fromInput').value = toValue;
            document.getElementById('toInput').value = fromValue;
            
            if (toValue && fromValue) {
                searchRoute();
            }
        }

        async function searchRoute() {
            const toInput = document.getElementById('toInput').value.trim();
            if (!toInput) {
                showNotification('Please enter a destination', 'error');
                return;
            }

            let fromLatLng;
            let toLatLng;

            // Get "From" location
            if (userLocation) {
                fromLatLng = L.latLng(userLocation.lat, userLocation.lng);
            } else {
                // Try to geocode the "From" location
                const fromInput = document.getElementById('fromInput').value;
                if (fromInput && fromInput !== "My Current Location") {
                    try {
                        const geocodeResponse = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fromInput + ', Metro Manila, Philippines')}&limit=1`
                        );
                        
                        if (geocodeResponse.ok) {
                            const data = await geocodeResponse.json();
                            if (data.length > 0) {
                                fromLatLng = L.latLng(parseFloat(data[0].lat), parseFloat(data[0].lon));
                            } else {
                                showNotification('Starting point not found', 'error');
                                return;
                            }
                        }
                    } catch (error) {
                        console.error('Geocoding error:', error);
                        showNotification('Error finding starting point', 'error');
                        return;
                    }
                } else {
                    showNotification('Please enable location services or enter a starting point', 'error');
                    return;
                }
            }

            // Get "To" location via enhanced geocoding
            try {
                // Try multiple search strategies
                const searchQueries = [
                    toInput + ', Metro Manila, Philippines',
                    toInput + ', NCR, Philippines',
                    toInput
                ];
                
                let geocodeData = null;
                
                for (const query of searchQueries) {
                    const geocodeResponse = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`
                    );
                    
                    if (geocodeResponse.ok) {
                        const data = await geocodeResponse.json();
                        if (data.length > 0) {
                            // Find the best match (prefer Metro Manila results)
                            const bestMatch = data.find(item => 
                                item.display_name.includes('Metro Manila') || 
                                item.display_name.includes('NCR') ||
                                ncrCities.some(city => item.display_name.includes(city))
                            ) || data[0];
                            
                            geocodeData = bestMatch;
                            break;
                        }
                    }
                }
                
                if (geocodeData) {
                    toLatLng = L.latLng(parseFloat(geocodeData.lat), parseFloat(geocodeData.lon));
                    
                    // Update input with the found location
                    const displayName = geocodeData.display_name;
                    const nameParts = displayName.split(',');
                    const shortName = nameParts.slice(0, Math.min(3, nameParts.length)).join(',');
                    document.getElementById('toInput').value = shortName;
                } else {
                    showNotification('Destination not found. Please try a different location or be more specific.', 'error');
                    return;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                showNotification('Error finding destination. Please try again.', 'error');
                return;
            }

            // Clear previous route
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            if (activeRoute) {
                map.removeLayer(activeRoute);
            }

            // Create new route
            routingControl = L.Routing.control({
                waypoints: [fromLatLng, toLatLng],
                routeWhileDragging: false,
                showAlternatives: false,
                lineOptions: {
                    styles: [{ color: '#1e3c72', weight: 5, opacity: 0.7 }]
                },
                createMarker: function(i, waypoint, n) {
                    if (i === 0 && userLocation) {
                        return L.marker(waypoint.latLng, {
                            icon: L.divIcon({
                                className: 'start-marker',
                                html: '<div style="background:#4CAF50;color:white;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"><i class="fas fa-map-marker-alt"></i></div>',
                                iconSize: [30, 30]
                            })
                        });
                    } else {
                        return L.marker(waypoint.latLng, {
                            icon: L.divIcon({
                                className: 'end-marker',
                                html: '<div style="background:#f44336;color:white;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"><i class="fas fa-flag-checkered"></i></div>',
                                iconSize: [30, 30]
                            })
                        });
                    }
                }
            }).addTo(map);

            // Listen for route found event
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                
                // Update route info
                document.getElementById('routeDistance').textContent = 
                    (summary.totalDistance / 1000).toFixed(1) + ' km';
                document.getElementById('routeTime').textContent = 
                    Math.round(summary.totalTime / 60) + ' min';
                
                // Count turns
                const instructions = routes[0].instructions;
                const turnCount = instructions.filter(inst => 
                    inst.text.includes('Turn') || 
                    inst.text.includes('left') || 
                    inst.text.includes('right') ||
                    inst.text.includes('Continue') ||
                    inst.text.includes('Keep')
                ).length;
                document.getElementById('routeTurns').textContent = turnCount;
                
                // Add instructions to menu page
                const instructionsDiv = document.getElementById('routeInstructions');
                instructionsDiv.innerHTML = '';
                
                // Prepare navigation steps
                navigationSteps = [];
                
                instructions.forEach((instruction, index) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'instruction-step';
                    stepDiv.dataset.index = index;
                    if (index === 0) stepDiv.classList.add('active');
                    
                    // Get appropriate icon
                    let icon = 'fas fa-arrow-right';
                    if (instruction.text.includes('left')) icon = 'fas fa-arrow-left';
                    else if (instruction.text.includes('right')) icon = 'fas fa-arrow-right';
                    else if (instruction.text.includes('Continue') || instruction.text.includes('Keep')) icon = 'fas fa-arrow-up';
                    else if (instruction.text.includes('Arrive')) icon = 'fas fa-flag-checkered';
                    else if (instruction.text.includes('Head')) icon = 'fas fa-road';
                    else if (instruction.text.includes('Destination')) icon = 'fas fa-map-marker-alt';
                    
                    stepDiv.innerHTML = `
                        <div class="instruction-text">
                            <i class="${icon} instruction-icon"></i>
                            ${instruction.text}
                        </div>
                        <div class="instruction-distance">
                            <i class="fas fa-road"></i>
                            ${(instruction.distance / 1000).toFixed(2)} km
                        </div>
                    `;
                    
                    // Add click event to speak the instruction
                    stepDiv.addEventListener('click', () => {
                        speakNavigationInstruction(instruction, instruction.distance);
                        currentInstructionIndex = index;
                        
                        // Highlight clicked step
                        document.querySelectorAll('.instruction-step').forEach(step => {
                            step.classList.remove('active');
                        });
                        stepDiv.classList.add('active');
                    });
                    
                    instructionsDiv.appendChild(stepDiv);
                    
                    // Add to navigation steps array
                    navigationSteps.push({
                        text: instruction.text,
                        distance: instruction.distance,
                        icon: icon
                    });
                });
                
                // Highlight the route on map
                activeRoute = L.polyline(routes[0].coordinates, {
                    color: '#4CAF50',
                    weight: 8,
                    opacity: 0.8,
                    className: 'active-route'
                }).addTo(map);
                
                document.getElementById('routeInfo').style.display = 'block';
                routeFound = true;
                
                // Show Go button instead of Search
                showGoButton();
                
                // Switch to map page to see the route
                showMapPage();
                
                showNotification('Route found! Click "Go" to start navigation.');
            });

            // Fit map to route bounds
            map.fitBounds([fromLatLng, toLatLng], { padding: [50, 50] });
        }

        function startNavigation() {
            if (!routeFound) {
                showNotification('Please search for a route first', 'error');
                return;
            }
            
            isNavigationMode = true;
            
            // Enable voice navigation automatically
            if (enableVoiceNavigation()) {
                // Speak first instruction if available
                if (navigationSteps.length > 0) {
                    speak("Starting navigation. Please follow the highlighted route.");
                    
                    // Speak first instruction after a delay
                    setTimeout(() => {
                        const firstStep = navigationSteps[0];
                        if (firstStep) {
                            currentInstructionIndex = 0;
                            speakNavigationInstruction(firstStep, firstStep.distance);
                        }
                    }, 1500);
                }
            }
            
            // Zoom to appropriate level for navigation
            map.setZoom(15);
            
            // Start auto-tracking if not already
            if (!isTracking && userLocation) {
                startAutoTracking();
            }
            
            // Switch to map page for navigation
            showMapPage();
            
            showNotification('Navigation started! Voice guidance enabled.');
        }

        async function searchSuggestions(query) {
            if (query.length < 2) {
                // Show NCR hotspots for short queries
                if (query.length === 1) {
                    showNCRHotspots();
                } else {
                    document.getElementById('suggestions').style.display = 'none';
                }
                return;
            }

            try {
                // Combine NCR locations with API search
                const localResults = [...ncrCities, ...ncrLocations]
                    .filter(location => 
                        location.toLowerCase().includes(query.toLowerCase())
                    )
                    .slice(0, 5)
                    .map(location => ({
                        display_name: location + ', Metro Manila, Philippines',
                        type: 'local'
                    }));
                
                // API search for more specific results
                const apiResponse = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' Metro Manila')}&limit=5`
                );
                
                let apiResults = [];
                if (apiResponse.ok) {
                    apiResults = await apiResponse.json();
                }
                
                // Combine and deduplicate results
                const allResults = [...localResults, ...apiResults];
                const uniqueResults = [];
                const seen = new Set();
                
                allResults.forEach(result => {
                    const key = result.display_name.split(',')[0].toLowerCase();
                    if (!seen.has(key) && uniqueResults.length < 8) {
                        seen.add(key);
                        uniqueResults.push(result);
                    }
                });
                
                displaySuggestions(uniqueResults);
                
            } catch (error) {
                console.error('Suggestion error:', error);
                // Fallback to local NCR locations
                showNCRHotspots();
            }
        }

        function displaySuggestions(results) {
            const suggestionsList = document.getElementById('suggestionsList');
            suggestionsList.innerHTML = '';
            
            if (results.length > 0) {
                results.forEach(item => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'suggestion-item';
                    
                    // Determine icon based on type
                    let icon = 'fas fa-map-marker-alt';
                    let type = '';
                    
                    if (item.type === 'local') {
                        icon = 'fas fa-star';
                        type = 'NCR Location';
                    } else if (item.type === 'highway' || item.class === 'highway') {
                        icon = 'fas fa-road';
                        type = 'Road';
                    } else if (item.type === 'building' || item.class === 'amenity') {
                        icon = 'fas fa-building';
                        type = 'Building';
                    } else if (item.type === 'place' || item.class === 'place') {
                        icon = 'fas fa-city';
                        type = 'Area';
                    }
                    
                    const displayName = item.display_name;
                    const nameParts = displayName.split(',');
                    const mainName = nameParts[0];
                    const details = nameParts.slice(1, 3).join(',');
                    
                    suggestion.innerHTML = `
                        <div class="suggestion-main">
                            <i class="${icon} suggestion-icon"></i>
                            ${mainName}
                        </div>
                        <div class="suggestion-sub">
                            ${details}
                            ${type ? `<span style="margin-left: 10px; color: #1e3c72;">(${type})</span>` : ''}
                        </div>
                    `;
                    
                    suggestion.addEventListener('click', () => {
                        document.getElementById('toInput').value = displayName;
                        document.getElementById('suggestions').style.display = 'none';
                        searchRoute();
                    });
                    
                    suggestionsList.appendChild(suggestion);
                });
                document.getElementById('suggestions').style.display = 'block';
            } else {
                document.getElementById('suggestions').style.display = 'none';
            }
        }

        function showNCRHotspots() {
            const suggestionsList = document.getElementById('suggestionsList');
            suggestionsList.innerHTML = '';
            
            const query = document.getElementById('toInput').value.toLowerCase();
            const allHotspots = [...ncrCities, ...ncrLocations];
            const filteredHotspots = allHotspots.filter(hotspot => 
                hotspot.toLowerCase().includes(query)
            ).slice(0, 6);
            
            if (filteredHotspots.length > 0) {
                filteredHotspots.forEach(hotspot => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'suggestion-item';
                    suggestion.innerHTML = `
                        <div class="suggestion-main">
                            <i class="fas fa-star suggestion-icon"></i>
                            ${hotspot}
                        </div>
                        <div class="suggestion-sub">
                            Metro Manila, Philippines
                        </div>
                    `;
                    
                    suggestion.addEventListener('click', () => {
                        document.getElementById('toInput').value = hotspot + ', Metro Manila';
                        document.getElementById('suggestions').style.display = 'none';
                        searchRoute();
                    });
                    
                    suggestionsList.appendChild(suggestion);
                });
                document.getElementById('suggestions').style.display = 'block';
            } else {
                document.getElementById('suggestions').style.display = 'none';
            }
        }

        // ============================================
        // LOCATION FUNCTIONS
        // ============================================
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    updateLocationStatus('Geolocation not supported', 'error');
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                updateLocationStatus('Getting location...', 'loading');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        updateLocationStatus(`Location found! Accuracy: ${Math.round(userLocation.accuracy)}m`, 'success');
                        updateUserLocationMarker();
                        map.setView([userLocation.lat, userLocation.lng], 15);
                        autoFillLocationField();
                        
                        // Start auto-tracking immediately
                        startAutoTracking();
                        
                        document.getElementById('fromInput').value = "My Current Location";
                        
                        // Switch to map page to see location
                        showMapPage();
                        
                        resolve(userLocation);
                    },
                    (error) => {
                        let message = 'Location error: ';
                        switch(error.code) {
                            case 1: message = 'Permission denied'; break;
                            case 2: message = 'Position unavailable'; break;
                            case 3: message = 'Timeout'; break;
                        }
                        updateLocationStatus(message, 'error');
                        reject(new Error(message));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function updateUserLocationMarker() {
            if (!userLocation) return;
            
            if (userMarker) map.removeLayer(userMarker);
            
            const userIcon = L.divIcon({
                className: 'user-location-marker',
                iconSize: [35, 35],
                iconAnchor: [17, 17],
                html: `<div style="width:35px;height:35px;background:#1e3c72;border-radius:50%;border:3px solid white;box-shadow:0 0 15px rgba(30,60,114,0.5);display:flex;align-items:center;justify-content:center;color:white;font-size:14px;">üìç</div>`
            });
            
            userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map);
        }

        function updateLocationStatus(message, type = 'info') {
            const status = document.getElementById('locationStatus');
            const icon = document.getElementById('locationIcon');
            const text = document.getElementById('locationText');
            
            status.style.display = 'flex';
            status.className = `location-status ${type}`;
            
            switch(type) {
                case 'success': icon.innerHTML = '<i class="fas fa-check-circle"></i>'; break;
                case 'error': icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>'; break;
                case 'loading': icon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; break;
            }
            
            text.textContent = message;
        }

        async function autoFillLocationField() {
            if (!userLocation) return;
            
            const input = document.getElementById('locationInput');
            input.value = `${userLocation.lat.toFixed(5)}, ${userLocation.lng.toFixed(5)}`;
            selectedLocation = { lat: userLocation.lat, lng: userLocation.lng };
            validateForm();
            
            // Try to get address
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLocation.lat}&lon=${userLocation.lng}`
                );
                if (response.ok) {
                    const data = await response.json();
                    if (data.display_name) {
                        const address = data.display_name.split(',').slice(0, 3).join(',');
                        input.value = address;
                    }
                }
            } catch (error) {
                // Ignore geocoding errors
            }
        }

        function clearLocation() {
            userLocation = null;
            selectedLocation = null;
            if (userMarker) {
                map.removeLayer(userMarker);
                userMarker = null;
            }
            document.getElementById('locationInput').value = '';
            document.getElementById('locationStatus').style.display = 'none';
            document.getElementById('fromInput').value = '';
            validateForm();
            
            // Stop tracking
            stopAutoTracking();
        }

        // ============================================
        // AUTO TRACKING FUNCTIONS
        // ============================================
        function startAutoTracking() {
            if (!navigator.geolocation || !userLocation) return;
            
            // Clear any existing watch
            if (watchId) navigator.geolocation.clearWatch(watchId);
            
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    updateUserLocationMarker();
                    
                    // If we're in navigation mode, keep map centered on user
                    if (isNavigationMode) {
                        map.setView([userLocation.lat, userLocation.lng], 15);
                    }
                },
                (error) => {
                    console.error('Tracking error:', error);
                    stopAutoTracking();
                },
                { 
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 5000
                }
            );
            
            isTracking = true;
            console.log("Auto-tracking started");
        }

        function stopAutoTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTracking = false;
            console.log("Auto-tracking stopped");
        }

        // ============================================
        // FORM VALIDATION
        // ============================================
        function validateForm() {
            const username = document.getElementById('username').value.trim();
            const trafficType = document.getElementById('trafficType').value;
            const location = document.getElementById('locationInput').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = !(username.length >= 2 && trafficType && location && selectedLocation);
        }

        document.getElementById('username').addEventListener('input', validateForm);
        document.getElementById('trafficType').addEventListener('change', validateForm);
        document.getElementById('locationInput').addEventListener('input', validateForm);

        // ============================================
        // EVENT HANDLERS
        // ============================================
        // Direction handlers
        document.getElementById('swapBtn').addEventListener('click', swapLocations);
        document.getElementById('searchRouteBtn').addEventListener('click', searchRoute);

        // Search suggestions with debounce
        document.getElementById('toInput').addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                searchSuggestions(e.target.value);
            }, 300);
        });

        document.getElementById('useLocationBtn').addEventListener('click', () => {
            getUserLocation().catch(console.error);
        });

        document.getElementById('clearLocationBtn').addEventListener('click', clearLocation);

        document.getElementById('startHereBtn').addEventListener('click', () => {
            getUserLocation().catch(console.error);
        });

        // ============================================
        // FORM SUBMISSION
        // ============================================
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const trafficType = document.getElementById('trafficType').value;
            const location = document.getElementById('locationInput').value.trim();
            const description = document.getElementById('description').value.trim();
            
            if (!selectedLocation) {
                showNotification('Please select a location first', 'error');
                return;
            }

            const report = {
                type: trafficType,
                location: location,
                description: description || 'No additional details',
                username: username,
                lat: selectedLocation.lat,
                lng: selectedLocation.lng,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                date: new Date().toLocaleDateString()
            };

            try {
                const newReportRef = reportsRef.push();
                await newReportRef.set(report);
                
                // Clear form
                document.getElementById('trafficType').value = '';
                document.getElementById('locationInput').value = '';
                document.getElementById('description').value = '';
                selectedLocation = null;
                validateForm();
                
                // Collapse the report section after submission
                toggleSection('report');
                
                // Start auto-tracking if not already
                if (!isTracking && userLocation) {
                    startAutoTracking();
                }
                
                // Switch to map page
                showMapPage();
                
                showNotification('‚úÖ Report submitted successfully!');
                
            } catch (error) {
                console.error('Submission error:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        });

        // ============================================
        // MAP CLICK
        // ============================================
        map.on('click', function(e) {
            selectedLocation = e.latlng;
            
            if (window.tempMarker) map.removeLayer(window.tempMarker);
            
            window.tempMarker = L.circleMarker([e.latlng.lat, e.latlng.lng], {
                color: '#1e3c72',
                fillColor: '#1e3c72',
                fillOpacity: 0.3,
                radius: 10
            }).addTo(map);
            
            document.getElementById('locationInput').value = 
                `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
            
            updateLocationStatus('Location selected on map', 'success');
            validateForm();
        });

        // ============================================
        // FIREBASE DATA SYNC
        // ============================================
        function addReportToMap(report) {
            const config = typeConfig[report.type] || typeConfig.moderate;
            
            const marker = L.circleMarker([report.lat, report.lng], {
                color: config.color,
                fillColor: config.color,
                fillOpacity: 0.7,
                radius: 12,
                weight: 2
            }).addTo(map);
            
            marker.bindPopup(`
                <div style="font-weight: bold; color: ${config.color};">
                    ${config.emoji} ${config.label}
                </div>
                <div style="margin: 8px 0;">
                    <strong>üìç:</strong> ${report.location}
                </div>
                <div style="margin: 8px 0;">
                    <strong>üìù:</strong> ${report.description}
                </div>
                <div style="margin: 8px 0;">
                    <strong>üë§:</strong> ${report.username}
                </div>
                <div style="color: #666; font-size: 12px;">
                    ${report.time} ‚Ä¢ ${report.date}
                </div>
            `);
            
            markers[report.id] = marker;
        }

        function addReportToSidebar(report) {
            const container = document.getElementById('reportsContainer');
            const noReportsMsg = document.getElementById('noReports');
            
            if (noReportsMsg) noReportsMsg.style.display = 'none';
            
            const config = typeConfig[report.type] || typeConfig.moderate;
            
            const card = document.createElement('div');
            card.className = 'report-card';
            card.id = `report-${report.id}`;
            card.innerHTML = `
                <div class="report-header">
                    <span class="report-type" style="background: ${config.color}20; color: ${config.color};">
                        ${config.emoji} ${config.label}
                    </span>
                    <span class="report-time">${report.time}</span>
                </div>
                <div class="report-location">üìç ${report.location}</div>
                <div class="report-desc">${report.description}</div>
                <div class="report-user">üë§ ${report.username} ‚Ä¢ ${report.date}</div>
            `;
            
            card.addEventListener('click', () => {
                map.setView([report.lat, report.lng], 16);
                if (markers[report.id]) markers[report.id].openPopup();
                
                // Switch to map page
                showMapPage();
            });
            
            container.insertBefore(card, container.firstChild);
        }

        // Listen for new reports
        reportsRef.on('child_added', function(snapshot) {
            const report = snapshot.val();
            report.id = snapshot.key;
            addReportToMap(report);
            addReportToSidebar(report);
        });

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // ============================================
        // INITIAL LOAD
        // ============================================
        // Initialize speech synthesis voices
        if (speechSynthesis) {
            // Some browsers need this to load voices
            speechSynthesis.onvoiceschanged = function() {
                console.log('Voices loaded:', speechSynthesis.getVoices().length);
            };
        }

        // Set up responsive layout
        window.addEventListener('resize', checkScreenSize);
        checkScreenSize();

        // Hide loading
        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            validateForm();
            showNotification('FilMap loaded! Click "Start Here" to begin.');
        }, 1000);

        // Load existing reports
        reportsRef.limitToLast(20).once('value').then((snapshot) => {
            if (snapshot.exists()) {
                document.getElementById('noReports').style.display = 'none';
                snapshot.forEach((childSnapshot) => {
                    const report = childSnapshot.val();
                    report.id = childSnapshot.key;
                    addReportToSidebar(report);
                });
            }
        });

        console.log("‚úÖ FilMap with Directions loaded!");
    </script>
</body>
</html>
