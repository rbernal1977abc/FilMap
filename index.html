<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <title>FilMap - NCR Traffic & Directions</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* BASIC STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Main container with split layout */
        .split-container {
            display: flex;
            height: 100vh;
            width: 200vw; /* 2x viewport width for split */
            transition: transform 0.3s ease;
        }
        
        .map-page, .menu-page {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Menu Page (Left) */
        .menu-page {
            background: #f8f9fa;
            overflow-y: auto;
        }
        
        .menu-page header {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 15px 20px;
            text-align: center;
            flex-shrink: 0;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }
        
        .menu-page header h1 {
            font-size: 1.4rem;
            margin: 0;
            order: 1;
            text-align: left;
            flex: 1;
        }
        
        .start-here-container {
            position: static;
            margin: 0;
            order: 2;
            align-self: center;
        }
        
        .start-here-btn {
            background: linear-gradient(to bottom, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .start-here-btn:hover {
            background: linear-gradient(to bottom, #45a049, #3d8b40);
            transform: translateY(-2px);
        }
        
        /* Map Page (Right) */
        .map-page {
            background: white;
            position: relative;
        }
        
        #map {
            flex: 1;
            width: 100%;
            z-index: 1;
        }
        
        /* Swipe indicator in bottom left - UPDATED TO REMOVE SMALL BOX */
        .swipe-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            font-size: 0.75rem;
            color: black;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 15px;
            border-radius: 15px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
            font-weight: 500;
        }
        
        .swipe-indicator i {
            font-size: 0.8rem;
            color: #1e3c72;
        }
        
        /* Map Controls */
        .map-controls { 
            position: absolute; 
            bottom: 80px; 
            right: 20px; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        
        /* Location Button */
        .location-btn {
            background: white;
            color: #1e3c72;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .location-btn:hover {
            background: #f0f0f0;
            transform: scale(1.1);
        }
        
        /* Navigation Panels on Map - UPDATED TO RIGHT SIDE */
        .route-panel {
            position: absolute;
            top: 20px;
            right: 20px; /* Changed from left: 20px; right: 20px; */
            z-index: 1000;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            overflow: hidden;
            display: none;
            max-height: 80vh;
            width: 350px; /* Added fixed width */
            max-width: calc(100% - 40px); /* Ensure it doesn't overflow on mobile */
        }
        
        .route-panel.active {
            display: block;
        }
        
        .route-panel-header {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .route-panel-header h3 {
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .route-panel-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 20px;
            background: white;
        }
        
        .panel-toggle-icon {
            transition: transform 0.3s;
            font-size: 0.9rem;
        }
        
        .panel-toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        
        .section-header { 
            background: linear-gradient(to right, #1e3c72, #2a5298); 
            color: white; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            transition: all 0.3s;
        }
        .section-header:hover { background: linear-gradient(to right, #2a5298, #3a62a8); }
        .section-header h3 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .toggle-icon { transition: transform 0.3s; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }
        .section-content { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            display: block;
        }
        .section-content.collapsed { display: none; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        .required::after { content: " *"; color: #f44336; }
        select, textarea, input { width: 100%; padding: 14px 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; }
        select:focus, textarea:focus, input:focus { border-color: #2a5298; outline: none; box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.2); }
        textarea { resize: vertical; min-height: 100px; }
        .button-group { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; }
        button { background: linear-gradient(to right, #1e3c72, #2a5298); color: white; border: none; padding: 16px 20px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; flex: 1; min-width: 120px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:disabled { background: #cccccc; cursor: not-allowed; opacity: 0.7; }
        button.secondary { background: linear-gradient(to right, #4CAF50, #45a049); }
        button.danger { background: linear-gradient(to right, #f44336, #d32f2f); }
        button.small { padding: 12px 15px; font-size: 0.9rem; }
        button.info { background: linear-gradient(to right, #2196F3, #1976D2); }
        button.go { 
            background: linear-gradient(to right, #4CAF50, #45a049);
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.2);
        }
        .location-status { padding: 12px 15px; border-radius: 10px; margin-bottom: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .location-status.success { background: #d4edda; color: #155724; border-left: 4px solid #4CAF50; }
        .location-status.error { background: #f8d7da; color: #721c24; border-left: 4px solid #f44336; }
        .location-status.loading { background: #e8f4f8; color: #0c5460; border-left: 4px solid #17a2b8; }
        .reports-list { margin-top: 20px; }
        .reports-list h3 { color: #1e3c72; margin-bottom: 15px; font-size: 1.2rem; }
        .report-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 5px solid #4CAF50; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .report-type { background: #e8eaf6; color: #1e3c72; padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: 600; }
        .report-time { color: #666; font-size: 0.8rem; }
        .report-location { color: #333; margin: 6px 0; font-weight: 600; }
        .report-desc { color: #555; line-height: 1.5; font-size: 0.9rem; }
        .report-user { font-size: 0.8rem; color: #888; margin-top: 8px; }
        .notification { position: fixed; top: 10px; right: 10px; left: 10px; background: #4CAF50; color: white; padding: 15px; border-radius: 10px; display: none; z-index: 10000; text-align: center; }
        .notification.error { background: #f44336; }
        
        /* Directions Input Group */
        .directions-input-group { margin-bottom: 15px; }
        .directions-input { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
            align-items: center;
        }
        .directions-input .icon { 
            background: #e8eaf6; 
            border-radius: 50%; 
            width: 35px; 
            height: 35px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #1e3c72; 
            flex-shrink: 0;
        }
        .directions-input input { 
            flex: 1; 
            padding: 12px 15px; 
            border: 2px solid #e0e0e0; 
            border-radius: 10px; 
            font-size: 0.95rem;
        }
        .directions-input input:focus { 
            border-color: #2a5298; 
            outline: none;
        }
        .swap-btn { 
            background: #f0f0f0; 
            border: none; 
            border-radius: 50%; 
            width: 35px; 
            height: 35px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            margin-left: 22px;
        }
        
        /* Route Summary */
        .route-summary { 
            display: flex; 
            justify-content: space-between; 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 15px; 
        }
        .route-summary-item { text-align: center; }
        .route-value { 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #1e3c72; 
            display: block;
        }
        .route-label { 
            font-size: 0.85rem; 
            color: #666; 
            margin-top: 5px;
        }
        .route-instructions { 
            max-height: 300px; 
            overflow-y: auto; 
            margin-top: 10px;
            padding-right: 5px;
        }
        .instruction-step { 
            padding: 12px; 
            border-left: 4px solid #2196F3; 
            margin-bottom: 10px; 
            background: white;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
        }
        .instruction-step:hover { 
            transform: translateX(5px);
            background: #f0f9ff;
        }
        .instruction-step.active { 
            border-left-color: #4CAF50;
            background: #f0f9ff;
        }
        .instruction-text { 
            color: #333; 
            font-weight: 500;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .instruction-distance { 
            color: #666; 
            font-size: 0.85rem; 
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 26px;
        }
        .instruction-icon {
            color: #2196F3;
            font-size: 0.9rem;
            min-width: 20px;
        }
        
        /* Suggestions */
        #suggestions { 
            margin-top: 10px; 
            display: none;
            position: relative;
            z-index: 1000;
        }
        .suggestion-item { 
            padding: 12px 15px; 
            border-bottom: 1px solid #eee; 
            cursor: pointer; 
            background: white;
            transition: all 0.2s;
        }
        .suggestion-item:hover { 
            background: #f5f5f5;
            transform: translateX(5px);
        }
        .suggestion-main { 
            font-weight: 600; 
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .suggestion-sub { 
            font-size: 0.85rem; 
            color: #666;
            margin-top: 4px;
            margin-left: 26px;
        }
        .suggestion-icon {
            color: #1e3c72;
            font-size: 0.9rem;
        }
        
        /* Active Route Highlight */
        .active-route { 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-size: 1.2rem;
            color: #1e3c72;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Voice Control */
        .voice-control {
            position: absolute;
            bottom: 140px;
            right: 20px;
            z-index: 1000;
        }
        
        .voice-btn {
            background: white;
            color: #1e3c72;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .voice-btn.active {
            background: #4CAF50;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .voice-btn:hover {
            transform: scale(1.1);
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .split-container {
                width: 100vw;
                transform: translateX(0) !important;
            }
            
            .map-page, .menu-page {
                width: 50vw;
            }
            
            .route-panel {
                max-width: 400px;
                right: 20px; /* Keep on right side */
                left: auto; /* Ensure it doesn't inherit left positioning */
            }
            
            .menu-content {
                padding: 0 20px;
            }
        }
        
        @media (max-width: 767px) {
            .split-container {
                width: 200vw;
            }
            
            .map-page, .menu-page {
                width: 100vw;
            }
            
            .menu-page header {
                padding: 12px 15px;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .menu-page header h1 {
                font-size: 1.2rem;
            }
            
            .start-here-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
            
            .route-summary { 
                flex-direction: column; 
                gap: 10px; 
            }
            .route-summary-item { flex: 1; }
            
            .menu-content {
                padding: 0 15px;
                overflow-y: auto;
                height: calc(100vh - 140px);
            }
            
            .section-content {
                padding: 15px;
            }
            
            .route-panel {
                right: 10px; /* Keep on right side */
                left: 10px; /* Only on mobile for full width */
                width: auto; /* Full width on mobile */
                max-width: calc(100% - 20px);
            }
            
            .swipe-indicator {
                left: 10px;
                bottom: 10px;
                font-size: 0.7rem;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Loading FilMap...</p>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Route Panel on Map (Collapsible) - NOW ON RIGHT SIDE -->
    <div class="route-panel" id="routePanel">
        <div class="route-panel-header" id="routePanelHeader">
            <h3><i class="fas fa-route"></i> Route to Destination</h3>
            <span class="panel-toggle-icon"><i class="fas fa-chevron-up"></i></span>
        </div>
        <div class="route-panel-content" id="routePanelContent">
            <div class="route-summary">
                <div class="route-summary-item">
                    <span class="route-value" id="routeDistance">--</span>
                    <span class="route-label">Distance</span>
                </div>
                <div class="route-summary-item">
                    <span class="route-value" id="routeTime">--</span>
                    <span class="route-label">Time</span>
                </div>
                <div class="route-summary-item">
                    <span class="route-value" id="routeTurns">--</span>
                    <span class="route-label">Turns</span>
                </div>
            </div>
            
            <h4 style="margin-top: 15px; margin-bottom: 10px; color: #1e3c72;">
                <i class="fas fa-directions"></i> Turn-by-Turn Directions
            </h4>
            <div class="route-instructions" id="routeInstructions"></div>
        </div>
    </div>
    
    <!-- Voice Control Button -->
    <div class="voice-control" id="voiceControl">
        <button class="voice-btn" id="toggleVoiceBtn" title="Toggle Voice Guidance">
            <i class="fas fa-volume-up"></i>
        </button>
    </div>
    
    <!-- Location Button on Map -->
    <div class="map-controls" id="mapControls">
        <button class="location-btn" id="goToLocationBtn" title="Go to my location">
            <i class="fas fa-location-arrow"></i>
        </button>
    </div>
    
    <!-- Swipe indicator - UPDATED: Removed the small box styling -->
    <div class="swipe-indicator" id="swipeIndicator">
        <i class="fas fa-arrow-right"></i> Swipe right to Menu
    </div>
    
    <!-- Main split container -->
    <div class="split-container" id="splitContainer">
        <!-- Menu Page (Left) -->
        <div class="menu-page">
            <header>
                <h1>üó∫Ô∏è FilMap</h1>
                <div class="start-here-container">
                    <button class="start-here-btn" id="startHereBtn">
                        <i class="fas fa-play-circle"></i> Start Here
                    </button>
                </div>
            </header>
            
            <div class="menu-content">
                <!-- GET DIRECTIONS SECTION -->
                <div class="section-header" id="directionsHeader">
                    <h3><i class="fas fa-route"></i> Get Directions</h3>
                    <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
                </div>
                
                <div class="section-content" id="directionsContent">
                    <div class="location-status" id="locationStatus" style="display: none;">
                        <span id="locationIcon"><i class="fas fa-map-marker-alt"></i></span>
                        <span id="locationText">Detecting your location...</span>
                    </div>
                    
                    <div class="directions-input-group">
                        <div class="directions-input">
                            <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
                            <input type="text" id="fromInput" placeholder="From (My Destination)" readonly>
                        </div>
                        <div class="swap-btn" id="swapBtn">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="directions-input">
                            <div class="icon"><i class="fas fa-flag-checkered"></i></div>
                            <input type="text" id="toInput" placeholder="To (Destination in NCR)" autocomplete="off">
                        </div>
                    </div>
                    
                    <div id="suggestions">
                        <div id="suggestionsList"></div>
                    </div>
                    
                    <div class="button-group" id="directionButtons">
                        <button id="searchRouteBtn" class="info">
                            <i class="fas fa-search"></i> Search Route
                        </button>
                        <button id="clearRouteBtn" class="danger small">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- REPORT TRAFFIC SECTION -->
                <div class="section-header" id="reportHeader">
                    <h3><i class="fas fa-edit"></i> Report Traffic</h3>
                    <span class="toggle-icon collapsed"><i class="fas fa-chevron-down"></i></span>
                </div>
                
                <div class="section-content collapsed" id="reportContent">
                    <form id="reportForm">
                        <div class="form-group">
                            <label for="trafficType" class="required"><i class="fas fa-traffic-light"></i> Traffic Condition</label>
                            <select id="trafficType" required>
                                <option value="">-- Select Type --</option>
                                <option value="light">‚úÖ Light Traffic</option>
                                <option value="moderate">‚ö†Ô∏è Moderate Traffic</option>
                                <option value="heavy">üöó Heavy Traffic</option>
                                <option value="accident">üö® Accident / Crash</option>
                                <option value="roadwork">üõ†Ô∏è Road Construction</option>
                                <option value="flood">üåä Flooding / Hazard</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="locationInput" class="required"><i class="fas fa-map-pin"></i> Location Description</label>
                            <input type="text" id="locationInput" placeholder="e.g., 'EDSA Northbound near Guadalupe'" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="description"><i class="fas fa-info-circle"></i> Additional Details (Optional)</label>
                            <textarea id="description" placeholder="Any extra information about the traffic situation..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="username" class="required"><i class="fas fa-user"></i> Your Name</label>
                            <input type="text" id="username" placeholder="Enter your name" required minlength="2">
                        </div>
                        
                        <div class="button-group">
                            <button type="button" id="useLocationBtn" class="secondary small">
                                <i class="fas fa-location-arrow"></i> My Location
                            </button>
                            <button type="button" id="clearLocationBtn" class="danger small">
                                <i class="fas fa-times"></i> Clear
                            </button>
                            <button type="submit" id="submitBtn">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- LIVE REPORTS SECTION -->
                <div class="reports-list">
                    <h3><i class="fas fa-sync-alt"></i> Live Community Reports</h3>
                    <div id="reportsContainer">
                        <p style="text-align: center; color: #777; padding: 20px;" id="noReports">
                            No reports yet. Be the first to report!
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Page (Right) -->
        <div class="map-page">
            <div id="map"></div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ============================================
        // SIMPLIFIED INITIALIZATION
        // ============================================
        console.log("üöÄ Starting FilMap...");
        
        // Show loading overlay
        document.getElementById('loadingOverlay').style.display = 'flex';

        // Initialize Firebase
        let database, reportsRef;
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyDxlD4Hz5CFx88BdX53Os2PCBzroyBfusE",
                authDomain: "filmap-ncr.firebaseapp.com",
                databaseURL: "https://filmap-ncr-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "filmap-ncr",
                storageBucket: "filmap-ncr.appspot.com",
                messagingSenderId: "493798255142",
                appId: "1:493798255142:web:5b99520b9923fa051e54e7"
            };
            
            const app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            reportsRef = database.ref('trafficReports');
            console.log("‚úÖ Firebase initialized");
        } catch (error) {
            console.error("‚ùå Firebase error:", error);
            document.getElementById('loadingOverlay').innerHTML = `
                <div style="text-align: center; color: #f44336;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h3>Firebase Connection Error</h3>
                    <p>${error.message}</p>
                    <p style="font-size: 0.9rem; margin-top: 20px;">Continuing without Firebase...</p>
                </div>
            `;
        }

        // Initialize Map (Simplified)
        let map;
        try {
            map = L.map('map').setView([14.5995, 120.9842], 12);
            
            // Add default tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            console.log("‚úÖ Map initialized");
        } catch (error) {
            console.error("‚ùå Map error:", error);
            document.getElementById('loadingOverlay').innerHTML = `
                <div style="text-align: center; color: #f44336;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h3>Map Loading Error</h3>
                    <p>${error.message}</p>
                    <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #1e3c72; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Reload Page
                    </button>
                </div>
            `;
            throw error;
        }

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let selectedLocation = null;
        let userLocation = null;
        let userMarker = null;
        let watchId = null;
        let isTracking = false;
        const markers = {};
        let routingControl = null;
        let debounceTimer;
        let activeRoute = null;
        let routeFound = false;
        let voiceEnabled = true;
        let speechSynthesis = window.speechSynthesis;
        let currentInstructionIndex = 0;
        let isNavigationMode = false;
        let navigationSteps = [];
        let routeCoordinates = [];
        let currentRoute = null;
        let voiceCheckInterval = null;
        let isVoiceActive = false;
        let lastSpokenInstruction = null;
        let userOnRoute = true;

        // ============================================
        // PAGE NAVIGATION FUNCTIONS
        // ============================================
        let touchStartX = 0;
        let touchEndX = 0;
        let currentPage = 'menu';
        
        function showMapPage() {
            document.getElementById('splitContainer').style.transform = 'translateX(-100vw)';
            currentPage = 'map';
        }
        
        function showMenuPage() {
            document.getElementById('splitContainer').style.transform = 'translateX(0)';
            currentPage = 'menu';
        }
        
        // Initialize to show menu page
        showMenuPage();
        
        // Add touch events for mobile swipe
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, false);
        
        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);
        
        function handleSwipe() {
            const swipeThreshold = 50;
            const swipeDistance = touchEndX - touchStartX;
            
            if (Math.abs(swipeDistance) > swipeThreshold) {
                if (swipeDistance > 0 && currentPage === 'map') {
                    showMenuPage();
                } else if (swipeDistance < 0 && currentPage === 'menu') {
                    showMapPage();
                }
            }
        }
        
        // Route panel toggle
        document.getElementById('routePanelHeader').addEventListener('click', function() {
            const icon = this.querySelector('.panel-toggle-icon');
            const content = document.getElementById('routePanelContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('collapsed');
            } else {
                content.style.display = 'none';
                icon.classList.add('collapsed');
            }
        });

        // ============================================
        // VOICE FUNCTIONS
        // ============================================
        document.getElementById('toggleVoiceBtn').addEventListener('click', function() {
            voiceEnabled = !voiceEnabled;
            const btn = document.getElementById('toggleVoiceBtn');
            if (voiceEnabled) {
                btn.classList.add('active');
                showNotification('Voice guidance enabled');
                speak("Voice guidance enabled");
            } else {
                btn.classList.remove('active');
                showNotification('Voice guidance disabled');
                if (speechSynthesis) {
                    speechSynthesis.cancel();
                }
            }
        });

        // Initialize voice button state
        document.getElementById('toggleVoiceBtn').classList.add('active');

        function speak(text) {
            if (!voiceEnabled || !speechSynthesis) return;
            
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.1;
            utterance.volume = 1;
            
            speechSynthesis.speak(utterance);
        }

        // ============================================
        // LOCATION FUNCTIONS
        // ============================================
        document.getElementById('goToLocationBtn').addEventListener('click', function() {
            if (userLocation) {
                map.setView([userLocation.lat, userLocation.lng], 15);
                showNotification('Centered on your location');
                if (voiceEnabled) speak("Centered on your location");
            } else {
                getUserLocation().then(() => {
                    map.setView([userLocation.lat, userLocation.lng], 15);
                }).catch(error => {
                    showNotification('Unable to get your location', 'error');
                });
            }
        });

        document.getElementById('startHereBtn').addEventListener('click', function() {
            getUserLocation().then(() => {
                showNotification('Location acquired! You can now search for directions.');
                if (voiceEnabled) speak("Location ready. You can now search for directions.");
                document.getElementById('fromInput').value = "My Current Location";
            }).catch(error => {
                console.error('Location error:', error);
                showNotification('Unable to get your location', 'error');
            });
        });

        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    updateLocationStatus('Geolocation not supported', 'error');
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                updateLocationStatus('Getting location...', 'loading');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        updateLocationStatus(`Location found! Accuracy: ${Math.round(userLocation.accuracy)}m`, 'success');
                        updateUserLocationMarker();
                        
                        autoFillLocationField();
                        
                        startAutoTracking();
                        
                        document.getElementById('fromInput').value = "My Current Location";
                        
                        if (voiceEnabled) speak("Location found. Ready for navigation.");
                        
                        resolve(userLocation);
                    },
                    (error) => {
                        let message = 'Location error: ';
                        switch(error.code) {
                            case 1: message = 'Permission denied'; break;
                            case 2: message = 'Position unavailable'; break;
                            case 3: message = 'Timeout'; break;
                        }
                        updateLocationStatus(message, 'error');
                        reject(new Error(message));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function updateUserLocationMarker() {
            if (!userLocation) return;
            
            if (userMarker) map.removeLayer(userMarker);
            
            const userIcon = L.divIcon({
                className: 'user-location-marker',
                iconSize: [35, 35],
                iconAnchor: [17, 17],
                html: `<div style="width:35px;height:35px;background:#1e3c72;border-radius:50%;border:3px solid white;box-shadow:0 0 15px rgba(30,60,114,0.5);display:flex;align-items:center;justify-content:center;color:white;font-size:14px;">üìç</div>`
            });
            
            userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map);
        }

        function updateLocationStatus(message, type = 'info') {
            const status = document.getElementById('locationStatus');
            const icon = document.getElementById('locationIcon');
            const text = document.getElementById('locationText');
            
            status.style.display = 'flex';
            status.className = `location-status ${type}`;
            
            switch(type) {
                case 'success': icon.innerHTML = '<i class="fas fa-check-circle"></i>'; break;
                case 'error': icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>'; break;
                case 'loading': icon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; break;
            }
            
            text.textContent = message;
        }

        async function autoFillLocationField() {
            if (!userLocation) return;
            
            const input = document.getElementById('locationInput');
            input.value = `${userLocation.lat.toFixed(5)}, ${userLocation.lng.toFixed(5)}`;
            selectedLocation = { lat: userLocation.lat, lng: userLocation.lng };
            validateForm();
        }

        // ============================================
        // DIRECTION FUNCTIONS
        // ============================================
        document.getElementById('swapBtn').addEventListener('click', function() {
            const fromValue = document.getElementById('fromInput').value;
            const toValue = document.getElementById('toInput').value;
            
            if (fromValue === "My Current Location") {
                showNotification("Cannot swap with current location", "error");
                return;
            }
            
            document.getElementById('fromInput').value = toValue;
            document.getElementById('toInput').value = fromValue;
            
            if (toValue && fromValue) {
                searchRoute();
            }
        });

        async function searchRoute() {
            const toInput = document.getElementById('toInput').value.trim();
            if (!toInput) {
                showNotification('Please enter a destination', 'error');
                if (voiceEnabled) speak("Please enter a destination");
                return;
            }

            let fromLatLng;
            let toLatLng;

            // Get "From" location
            if (userLocation) {
                fromLatLng = L.latLng(userLocation.lat, userLocation.lng);
            } else {
                showNotification('Please enable location services or enter a starting point', 'error');
                if (voiceEnabled) speak("Please enable location services");
                return;
            }

            // Get "To" location
            try {
                const geocodeResponse = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(toInput + ', Metro Manila, Philippines')}&limit=1`
                );
                
                if (geocodeResponse.ok) {
                    const data = await geocodeResponse.json();
                    if (data.length > 0) {
                        toLatLng = L.latLng(parseFloat(data[0].lat), parseFloat(data[0].lon));
                    } else {
                        showNotification('Destination not found', 'error');
                        if (voiceEnabled) speak("Destination not found");
                        return;
                    }
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                showNotification('Error finding destination', 'error');
                return;
            }

            // Clear previous route
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            if (activeRoute) {
                map.removeLayer(activeRoute);
            }

            // Create new route
            routingControl = L.Routing.control({
                waypoints: [fromLatLng, toLatLng],
                routeWhileDragging: false,
                showAlternatives: false,
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: false,
                show: false,
                lineOptions: {
                    styles: [{ color: '#1e3c72', weight: 5, opacity: 0.7 }]
                }
            }).addTo(map);

            // Listen for route found event
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                
                // STORE ROUTE DATA
                currentRoute = routes[0];
                routeCoordinates = routes[0].coordinates;
                userOnRoute = true;
                
                // Update route info in panel
                document.getElementById('routeDistance').textContent = 
                    (summary.totalDistance / 1000).toFixed(1) + ' km';
                document.getElementById('routeTime').textContent = 
                    Math.round(summary.totalTime / 60) + ' min';
                
                const instructions = routes[0].instructions;
                const turnCount = instructions.filter(inst => 
                    inst.text.includes('Turn') || 
                    inst.text.includes('left') || 
                    inst.text.includes('right')
                ).length;
                document.getElementById('routeTurns').textContent = turnCount;
                
                // Add instructions to panel
                const instructionsDiv = document.getElementById('routeInstructions');
                instructionsDiv.innerHTML = '';
                
                navigationSteps = [];
                
                instructions.forEach((instruction, index) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'instruction-step';
                    stepDiv.dataset.index = index;
                    if (index === 0) stepDiv.classList.add('active');
                    
                    let icon = 'fas fa-arrow-right';
                    if (instruction.text.includes('left')) icon = 'fas fa-arrow-left';
                    else if (instruction.text.includes('right')) icon = 'fas fa-arrow-right';
                    else if (instruction.text.includes('Continue') || instruction.text.includes('Keep')) icon = 'fas fa-arrow-up';
                    else if (instruction.text.includes('Arrive')) icon = 'fas fa-flag-checkered';
                    else if (instruction.text.includes('Head')) icon = 'fas fa-road';
                    else if (instruction.text.includes('Destination')) icon = 'fas fa-map-marker-alt';
                    
                    stepDiv.innerHTML = `
                        <div class="instruction-text">
                            <i class="${icon} instruction-icon"></i>
                            ${instruction.text}
                        </div>
                        <div class="instruction-distance">
                            <i class="fas fa-road"></i>
                            ${(instruction.distance / 1000).toFixed(2)} km
                        </div>
                    `;
                    
                    stepDiv.addEventListener('click', () => {
                        speak(instruction.text);
                        currentInstructionIndex = index;
                        
                        document.querySelectorAll('.instruction-step').forEach(step => {
                            step.classList.remove('active');
                        });
                        stepDiv.classList.add('active');
                    });
                    
                    instructionsDiv.appendChild(stepDiv);
                    
                    navigationSteps.push({
                        text: instruction.text,
                        distance: instruction.distance,
                        icon: icon,
                        index: index
                    });
                });
                
                // Highlight the route on map
                activeRoute = L.polyline(routes[0].coordinates, {
                    color: '#4CAF50',
                    weight: 8,
                    opacity: 0.8,
                    className: 'active-route'
                }).addTo(map);
                
                // Show route panel - NOW ON RIGHT SIDE
                document.getElementById('routePanel').classList.add('active');
                routeFound = true;
                
                // Switch to map page
                showMapPage();
                
                showNotification('Route found!');
                if (voiceEnabled) speak("Route found.");
            });

            map.fitBounds([fromLatLng, toLatLng], { padding: [50, 50] });
        }

        function clearRoute() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            
            if (activeRoute) {
                map.removeLayer(activeRoute);
                activeRoute = null;
            }
            
            document.getElementById('routePanel').classList.remove('active');
            document.getElementById('toInput').value = '';
            document.getElementById('suggestions').style.display = 'none';
            routeFound = false;
            isNavigationMode = false;
            
            showMenuPage();
            
            if (voiceEnabled) speak("Route cleared");
        }

        // ============================================
        // SUGGESTIONS
        // ============================================
        document.getElementById('toInput').addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (e.target.value.length >= 2) {
                    showSuggestions(e.target.value);
                } else {
                    document.getElementById('suggestions').style.display = 'none';
                }
            }, 300);
        });

        function showSuggestions(query) {
            const suggestions = [
                "EDSA, Metro Manila",
                "C5 Road, Metro Manila",
                "Quezon City",
                "Makati City",
                "Manila",
                "SM Mall of Asia",
                "Ninoy Aquino International Airport",
                "Bonifacio Global City",
                "Ortigas Center",
                "Rizal Park"
            ];
            
            const filtered = suggestions.filter(s => 
                s.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 5);
            
            const suggestionsList = document.getElementById('suggestionsList');
            suggestionsList.innerHTML = '';
            
            if (filtered.length > 0) {
                filtered.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = suggestion;
                    div.addEventListener('click', () => {
                        document.getElementById('toInput').value = suggestion;
                        document.getElementById('suggestions').style.display = 'none';
                        searchRoute();
                    });
                    suggestionsList.appendChild(div);
                });
                document.getElementById('suggestions').style.display = 'block';
            } else {
                document.getElementById('suggestions').style.display = 'none';
            }
        }

        // ============================================
        // TOGGLE SECTIONS
        // ============================================
        document.getElementById('directionsHeader').addEventListener('click', function() {
            const content = document.getElementById('directionsContent');
            const icon = this.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        });

        document.getElementById('reportHeader').addEventListener('click', function() {
            const content = document.getElementById('reportContent');
            const icon = this.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        });

        // ============================================
        // FORM VALIDATION
        // ============================================
        function validateForm() {
            const username = document.getElementById('username').value.trim();
            const trafficType = document.getElementById('trafficType').value;
            const location = document.getElementById('locationInput').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = !(username.length >= 2 && trafficType && location && selectedLocation);
        }

        document.getElementById('username').addEventListener('input', validateForm);
        document.getElementById('trafficType').addEventListener('change', validateForm);
        document.getElementById('locationInput').addEventListener('input', validateForm);

        // ============================================
        // AUTO TRACKING
        // ============================================
        function startAutoTracking() {
            if (!navigator.geolocation || !userLocation) return;
            
            if (watchId) navigator.geolocation.clearWatch(watchId);
            
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    updateUserLocationMarker();
                },
                (error) => {
                    console.error('Tracking error:', error);
                    stopAutoTracking();
                },
                { 
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 5000
                }
            );
            
            isTracking = true;
        }

        function stopAutoTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTracking = false;
        }

        // ============================================
        // FORM SUBMISSION
        // ============================================
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const trafficType = document.getElementById('trafficType').value;
            const location = document.getElementById('locationInput').value.trim();
            const description = document.getElementById('description').value.trim();
            
            if (!selectedLocation) {
                showNotification('Please select a location first', 'error');
                return;
            }

            const report = {
                type: trafficType,
                location: location,
                description: description || 'No additional details',
                username: username,
                lat: selectedLocation.lat,
                lng: selectedLocation.lng,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                date: new Date().toLocaleDateString()
            };

            try {
                if (reportsRef) {
                    const newReportRef = reportsRef.push();
                    await newReportRef.set(report);
                }
                
                document.getElementById('trafficType').value = '';
                document.getElementById('locationInput').value = '';
                document.getElementById('description').value = '';
                selectedLocation = null;
                validateForm();
                
                showNotification('‚úÖ Report submitted successfully!');
                
            } catch (error) {
                console.error('Submission error:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        });

        // ============================================
        // MAP CLICK
        // ============================================
        map.on('click', function(e) {
            selectedLocation = e.latlng;
            
            if (window.tempMarker) map.removeLayer(window.tempMarker);
            
            window.tempMarker = L.circleMarker([e.latlng.lat, e.latlng.lng], {
                color: '#1e3c72',
                fillColor: '#1e3c72',
                fillOpacity: 0.3,
                radius: 10
            }).addTo(map);
            
            document.getElementById('locationInput').value = 
                `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
            
            updateLocationStatus('Location selected on map', 'success');
            validateForm();
        });

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // ============================================
        // INITIALIZE APP
        // ============================================
        // Set up button handlers
        document.getElementById('searchRouteBtn').addEventListener('click', searchRoute);
        document.getElementById('clearRouteBtn').addEventListener('click', clearRoute);
        document.getElementById('useLocationBtn').addEventListener('click', getUserLocation);
        document.getElementById('clearLocationBtn').addEventListener('click', function() {
            userLocation = null;
            selectedLocation = null;
            if (userMarker) {
                map.removeLayer(userMarker);
                userMarker = null;
            }
            document.getElementById('locationInput').value = '';
            document.getElementById('locationStatus').style.display = 'none';
            document.getElementById('fromInput').value = '';
            validateForm();
            stopAutoTracking();
        });

        // Hide loading overlay after everything is loaded
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                showNotification('FilMap loaded! Click "Start Here" to begin.');
                if (voiceEnabled) speak("FilMap navigation ready");
            }, 1500);
        });

        console.log("‚úÖ FilMap loaded successfully!");
    </script>
</body>
</html>
